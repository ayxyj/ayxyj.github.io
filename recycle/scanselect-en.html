<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="stylesheet" href="./css/scanstyle.css" href='./css/style.css'>
    <script type="text/javascript" src="./js/jsQR.js"></script>
    <title>Scan Qrcode</title>
</head>

<body>
    <canvas id="canvas" hidden></canvas>
    <div id="output" hidden>
        <div id="outputMessage">No QR code detected.</div>
        <div hidden><b>Data:</b> <span id="outputData"></span></div>
    </div>
    <div class="dropdown">
        <button onclick="myFunction()" class="dropbtn">Scan select</button>
        <div id="language" class="dropdown-content">
            <a href="./scanselect-zh-Hans.html">简体中文</a>
            <a href="./scanselect-zh-Hant.html">繁體中文</a>
            <a href="./scanselect-en.html">English</a>
        </div>
    </div>
</body>


<script>
    /* When the user clicks on the button, 
    toggle between hiding and showing the dropdown content */
    function myFunction() {
        document.getElementById("language").classList.toggle("show");
        console.log(1, 'dropdown-content');
    }

    // Close the dropdown if the user clicks outside of it
    window.onclick = function (event) {
        if (!event.target.matches('.dropbtn')) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            console.log(2, 'dropdown-content');
            var i;
            for (i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }
    }

    var video = document.createElement("video");
    var canvasElement = document.getElementById("canvas");
    var canvas = canvasElement.getContext("2d");
    var outputContainer = document.getElementById("output");
    var outputMessage = document.getElementById("outputMessage");
    var outputData = document.getElementById("outputData");
    var constraints = {
        audio: false,
        video: {
            width: { min: 320, ideal: 1280, max: 2560 },
            height: { min: 240, ideal: 720, max: 1440 },
            frameRate: {
                ideal: 120,
                min: 10
            },
            facingMode: "environment",
        }
    };

    function drawLine(begin, end, color) {
        canvas.beginPath();
        canvas.moveTo(begin.x, begin.y);
        canvas.lineTo(end.x, end.y);
        canvas.lineWidth = 4;
        canvas.strokeStyle = color;
        canvas.stroke();
    };

    function videoStart() {
        navigator.mediaDevices
            .getUserMedia(constraints)
            .then(function (stream) {
                //将视频流设置为video元素的源
                videoView.srcObject = stream;
                requestAnimationFrame(tick);
            })
            .catch(function (error) {
                console.error("Something is wrong.", error);
            });
    };

    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvasElement.hidden = false;
            outputContainer.hidden = false;

            canvasElement.height = video.videoHeight;
            canvasElement.width = video.videoWidth;
            canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
            var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
            var code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });
            if (code) {
                drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
                drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
                drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
                drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
                outputMessage.hidden = true;
                outputData.parentElement.hidden = false;
                outputData.innerText = code.data;
                var linkhttp = outputData.innerText;
                console.log('if', linkhttp.substring(0, 5));
                if (linkhttp.substring(0, 5) === 'https') {
                    console.log('qrcodehashttps');
                    var r = confirm("Do you really want to go on that page " + linkhttp + " ？");
                    if (r) {
                        window.location.assign(linkhttp);
                    } else {
                        console.log('取消跳转');
                    }
                } else {
                    console.log('qrcodehasnohttps');
                }
            } else {
                outputMessage.hidden = false;
                outputData.parentElement.hidden = true;
                linkhttp = outputData.innerText;
                console.log('noqrcode');
            }
        }
        requestAnimationFrame(tick);
    }
    window.addEventListener("load", videoStart, false);
</script>

</html>